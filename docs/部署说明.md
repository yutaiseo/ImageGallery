# 部署说明

## 基本约定

- 站点根目录为 Gallery。
- 安装入口为 /install/（Gallery/install/ 对外，逻辑在 run）。
- 后台入口为 /admin/（Gallery/admin/ 对外，逻辑在 ctrol）。
- 文档目录为 docs，备份目录为 backup（与 Gallery 同级）。

## 宝塔/aapanel (Nginx)

```
root /path/to/Gallery;
index index.php;
location /install/ { try_files $uri $uri/ /index.php?$query_string; }
location /admin/ { try_files $uri $uri/ /index.php?$query_string; }
location ~ \.php$ {
  include fastcgi_params;
  fastcgi_pass 127.0.0.1:9000;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
```

## 1panel (Nginx)

```
root /path/to/Gallery;
index index.php;
location /install/ { try_files $uri $uri/ /index.php?$query_string; }
location /admin/ { try_files $uri $uri/ /index.php?$query_string; }
location ~ \.php$ {
  include fastcgi_params;
  fastcgi_pass 127.0.0.1:9000;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
```

## Apache

```
DocumentRoot /path/to/Gallery
<Directory "/path/to/Gallery">
  AllowOverride All
  Require all granted
</Directory>
```

## Docker (Nginx + PHP-FPM)

```
root /path/to/Gallery;
index index.php;
location /install/ { try_files $uri $uri/ /index.php?$query_string; }
location /admin/ { try_files $uri $uri/ /index.php?$query_string; }
location ~ \.php$ {
  include fastcgi_params;
  fastcgi_pass php:9000;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
```

## 自建环境

### Nginx 配置

有两种方式配置 /install/ 和 /admin/ 路由：

**方式 1：直接 location 块（推荐）**

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/Gallery;
    index index.php;

    # 路由配置（单入口路由，不需要 Gallery/install 或 Gallery/admin 目录）
    location /install/ { 
      try_files $uri $uri/ /index.php?$query_string; 
    }
    location /admin/ { 
      try_files $uri $uri/ /index.php?$query_string; 
    }

    # PHP 处理
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
```

**方式 2：伪静态规则（如果使用了伪静态重写配置）**

如果已有其他伪静态规则，可在 rewrite 块中添加路由规则：

```nginx
# 在 http 块或 server 块内部
rewrite ^/install/(.*)$ /index.php?$query_string last;
rewrite ^/admin/(.*)$ /index.php?$query_string last;
```

**或者在 if 块中（仅当伪静态框架支持时）：**

```nginx
if (!-f $request_filename){
  if (!-d $request_filename){
    rewrite ^/install/(.*)$ /index.php?$query_string last;
    rewrite ^/admin/(.*)$ /index.php?$query_string last;
  }
}
```

### Apache 配置

确保 DocumentRoot 指向 Gallery 且 AllowOverride All，.htaccess 会自动处理路由：

```apache
DocumentRoot /path/to/Gallery
<Directory "/path/to/Gallery">
  AllowOverride All
  Require all granted
</Directory>
```

## 安装注意事项

- 访问 /install/ 进入安装。
- 安装完成后建议删除 run 目录或限制访问。
- 如 /install/ 或 /admin/ 404，优先检查站点根目录是否指向 Gallery，及路由是否配置。

## 备份与计划任务

### 概述

- 后台：/admin/backup.php
- 支持三种触发方式：手动备份、定期备份（每天指定时间）、Cron 定时任务

### 备份内容

- **数据库**（可选）：所有数据表完整导出
- **程序结构**（可选）：ctrol/ 和 Gallery/ 目录，自动排除 docs、run、backup 目录
- **上传文件**（可选）：Gallery/uploads/ 所有用户上传内容

### Cron 定时任务

调用示例（Linux Crontab）：

```bash
# 每天 2:00 AM 执行备份
0 2 * * * curl -fsS "https://your-domain.com/admin/backup.php?cron=1&token=你的Token" >/dev/null 2>&1
```

Windows 任务计划：

```
程序/脚本: curl.exe
参数: -fsS "https://your-domain.com/admin/backup.php?cron=1&token=你的Token"
```

### 云服务商配置

支持多个云存储提供商。配置文件应放在 ctrol/config/ 目录（非 web root），命名为 `cloud_config.json`（兼容 `oss_config.json`）。

#### 阿里云 OSS

```json
{
  "enabled": true,
  "key_id": "LTAI5txxxxxxxxxxxxxx",
  "key_secret": "VnRZxxxxxxxxxxxxxxxxxxxxxx",
  "endpoint": "oss-cn-hangzhou.aliyuncs.com",
  "bucket": "my-bucket",
  "prefix": "backups"
}
```

#### AWS S3

```json
{
  "enabled": true,
  "access_key": "AKIAIOSFODNN7EXAMPLE",
  "secret_key": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  "region": "us-east-1",
  "bucket": "my-bucket",
  "prefix": "backups"
}
```

#### 腾讯云 COS

```json
{
  "enabled": true,
  "secret_id": "AKIDxxxxxxxxxxxxxxxxxx",
  "secret_key": "xxxxxxxxxxxxxxxxxxxxxxxxxx",
  "region": "ap-beijing",
  "bucket": "my-bucket",
  "prefix": "backups"
}
```

#### OpenStack Swift

```json
{
  "enabled": true,
  "auth_url": "https://identity.api.rackspacecloud.com/v1.0",
  "username": "your-username",
  "password": "your-password",
  "tenant": "your-tenant",
  "container": "backups",
  "prefix": "daily"
}
```

### 备份目录

- 默认：../backup（Gallery 同级目录）
- 需确保目录可写（权限 755+）
- 后台设置支持自定义路径（绝对或相对）

### 注意事项

- 备份文件命名格式：backup_YYYYMMDD_HHMMSS.zip
- 包含 manifest.json 记录备份时间和内容选项
- 支持自动清理：删除超过配置天数的旧备份文件
- 云端上传失败不影响本地备份
