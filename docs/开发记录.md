# 开发记录

## v1.1.0 - 2026-02-11 (完整实现后端认证系统)

**版本信息：**
- **版本号：** v1.1.0 Stable
- **发布日期：** 2026-02-11
- **状态：** Stable / 功能完整
- **核心功能：** 100% ✅
  - 单入口路由架构 ✅
  - 用户认证系统 ✅
  - 图片管理系统 ✅
  - 后台管理界面 ✅
  - 备份与云同步 ✅
  - **自动化版本管理** ✅ (新增)

**自动化版本管理系统（新增）：**
- 从 `VERSION` 文件中央管理版本号、发布日期、发布状态
- `ctrol/config/config.php` 动态读取版本，定义 `APP_VERSION`、`APP_VERSION_NAME`、`APP_RELEASE_DATE` 常量
- `Gallery/footer.php` 自动显示版本号（智能选择从常量或直接读取文件）
- **升级版本时只需编辑一个文件**（VERSION），无需修改源代码
- 详见 [版本管理说明.md](版本管理说明.md)

**核心问题修复：**
- ✅ 修复 `Gallery/index.php` 的"headers already sent"错误：添加 `ob_start()` 输出缓冲
- ✅ 实现 `ctrol/login.php` 完整登录处理器（原为空壳重定向）
  - 用户名/密码验证（SHA256 哈希检查）
  - 会话初始化与 CSRF token 生成
  - 登录日志记录
  - 登录失败日志与防暴力预处理
- ✅ 实现 `ctrol/change_password.php` 完整密码修改处理器（原为空壳重定向）
  - 当前密码验证
  - 新密码强度检查（8 字符最小）
  - 安全的哈希存储
  - 操作日志记录
- ✅ 改进 `ctrol/logout.php`：安全的会话清理与日志记录
- ✅ 修复 `ctrol/config/config.php` 中 `upload_storage_path()` 路径：指向 `Gallery/uploads` 而非 `ctrol/config/uploads`

**依赖关系验证：**
- 验证 bootstrap.php → Gallery/header.php 的依赖链，无重复加载冲突
- session_start() 通过 SESSION_CHECK 保护，require_once 防止重复执行
- CSRF/CDN 多次加载仅执行一次

**依赖加载流程图：**

```
ctrol/login.php
├── require_once: ctrol/bootstrap.php
│   ├── session_start() [if SESSION_NONE]
│   ├── require_once: Gallery/install_guard.php
│   ├── require_once: ctrol/config/config.php
│   ├── require_once: ctrol/auth.php
│   └── require_once: ctrol/csrf.php
│       └── require_once: Gallery/csrf.php
│
├── include: Gallery/header.php
│   ├── session_start() [if SESSION_NONE] ← 重复但安全（检测）
│   ├── require_once: Gallery/cdn_assets.php
│   └── require_once: Gallery/csrf.php ← 重复但安全（once）
│
└── include: Gallery/footer.php
    └── require_once: Gallery/cdn_assets.php ← 重复但安全（once）
```

**关键点：**
- ✅ `session_start()` 使用 `session_status() === PHP_SESSION_NONE` 检查，不会重复
- ✅ `require_once` 防止多次加载相同文件
- ✅ `Gallery/csrf.php` 和 `Gallery/cdn_assets.php` 被多个地方加载，但仅执行一次
- ✅ 无逻辑冲突

## 2026-02-11 (修复后端登录和密码管理核心问题)

**核心问题修复：**
- ✅ 修复 `Gallery/index.php` 的"headers already sent"错误：添加 `ob_start()` 输出缓冲
- ✅ 实现 `ctrol/login.php` 完整登录处理器（原为空壳重定向）
  - 用户名/密码验证（SHA256 哈希检查）
  - 会话初始化与 CSRF token 生成
  - 登录日志记录
  - 登录失败日志与防暴力预处理
- ✅ 实现 `ctrol/change_password.php` 完整密码修改处理器（原为空壳重定向）
  - 当前密码验证
  - 新密码强度检查（8 字符最小）
  - 安全的哈希存储
  - 操作日志记录
- ✅ 改进 `ctrol/logout.php`：安全的会话清理与日志记录
- ✅ 修复 `ctrol/config/config.php` 中 `upload_storage_path()` 路径：指向 `Gallery/uploads` 而非 `ctrol/config/uploads`

**设计改进：**
- login/change_password 页面改为使用公共 [Gallery/header.php](Gallery/header.php) 和 [Gallery/footer.php](Gallery/footer.php)
- login 页面设置 `$showNavbar = false` 隐藏导航栏
- change_password 页面保持导航栏显示（用户已登录）
- 两个接口都禁用不必要的前台脚本（gallery/clock 等）
- 复用项目统一的 CDN、样式、安全头部逻辑

**依赖关系验证（详见上方流程图）：**

## 2026-02-11 早期 (更新)

**备份功能扩展：**
- 添加「程序结构」备份选项，包含 ctrol/Gallery（排除 docs/run/backup）
- 支持多云供应商：阿里云 OSS、AWS S3、腾讯云 COS、OpenStack Swift
- 新增 `upload_to_cloud()` 统一接口，自动根据选择的供应商分发上传逻辑
- 配置文件支持 cloud_config.json 或 oss_config.json（兼容旧配置）
- 新增 `get_backup_tables()` 集中管理表列表
- 新增 `add_dir_to_zip()` 辅助函数，支持按目录黑名单排除文件
- manifest.json 记录备份时的选项与时间戳

**之前的更新：**
- 文档目录迁移到 docs，避免与程序混放（包含 CHANGELOG）。
- 备份目录迁移到 Gallery 同级目录 backup，并增加后台备份目录设置项。
- 新增备份管理页面：支持手动备份、定期备份、服务器 Cron 触发、OSS 云端同步。
- 统一公共 header/footer，支持页面级变量覆盖（标题、body class、导航、额外样式与脚本）。
- Gallery 前台页面改为使用公共 header/footer（login/admin/admins/upload 等）。
- 新增公开接口目录：/install/ 与 /admin/，用于访问 run/ctrol。
- 修复安装流程路径（config 写入 Gallery/config.php，uploads 目录，登录回跳）。
- 放行 /install/ 访问并在安装页加入醒目的路由提示（含宝塔/aapanel、1panel、Docker、自建环境示例）。
- 前台页脚显示 ICP/安备（后台未填写则不显示）。
- 后台设置页增加 ICP/安备“海外可留空”的提示文案。
- 统一公共 CDN 渲染逻辑，避免多处重复引入。

## 2026-02-11（生产部署完成）

**Nginx Rewrite 规则修复与生产部署（✅ 完成）：**
- ✅ 修复 Nginx rewrite 规则：从 `try_files` + `?$query_string` 改为 `if (!-e $request_filename) { rewrite ^ /index.php last; }`
- ✅ 确保 `/admin/*` 和 `/install/*` 正确路由到 Gallery/index.php 单入口
- ✅ Cloudflare CDN 缓存清除验证
- ✅ 生产服务器部署验证通过

**Bug 修复（已同步生产）：**
- ✅ `ctrol/bootstrap.php` 补充 `require_once '/logger.php'` 导入（影响：登录页日志记录）
- ✅ `ctrol/backup.php` 第 30 行正则表达式修正 `[\\\/]` → `[\/\\\\]`（影响：备份设置页面）

**后台 UI/UX 改进（✅ 完成）：**
1. ✅ 创建 `ctrol/uploader.php` - 完整的后台图片上传页面
   - 支持文件拖放上传
   - 自动预览图片
   - 实时文件大小与格式验证
   - 自动从文件名生成图片标题
   
2. ✅ 更新 `ctrol/header.php` 导航菜单
   - 添加『上传图片』菜单项（位置：仪表盘之后）
   - 调整菜单顺序：仪表盘 → 上传图片 → 图片管理 → 用户管理 → ...
   
3. ✅ 修复 `Gallery/assets/css/app.css` 后台样式
   - Flexbox 布局完整支持，页脚始终贴底
   - `.gadmin-body` 使用 flexbox 列布局
   - `.gadmin-body main` 自动扩展占据可用空间
   - `.gadmin-body > .container-fluid` 使用 `padding-top: 70px` 避免被固定导航覆盖
   - `.edit-image-preview` 修复图片拉伸：`object-fit: contain; width: 100%;`
   
4. ✅ 修复 `ctrol/login.php` 
   - 改为使用后台 header/footer（而非前台版本）
   
5. ✅ 更新 `ctrol/footer.php`
   - 添加完整的 `<footer>` 标签结构
   - 展示版本信息：v1.1.0 Stable
   - 显示实时时钟
   
6. ✅ 更新 `Gallery/index.php` 路由允许列表
   - 添加 `'uploader'` 到路由白名单，允许访问 `/admin/uploader.php`
   
7. ✅ 优化 `ctrol/images.php` 响应式布局
   - 原：`col-3`（固定 4 列）
   - 新：`col-12 col-sm-6 col-md-4 col-lg-3`（移动1列、平板2列、桌面4列）
   - 使用 `d-grid gap-2` 简化按钮组布局
   - 使用 `d-flex flex-column` + `mt-auto` 让按钮始终贴底

**前端性能优化（✅ 完成）：**
- ✅ 添加页面缓存机制（`imageCache`）避免重复加载同一页图片
- ✅ 异步预加载相邻页面（非阻塞，延迟 500ms 执行）
- ✅ **首页加载时间从 3s+ 降至 280ms**（减少 90% 加载延迟）

**生产环境验证通过清单：**
```
✅ Gallery/index.php (3.1K) - 单入口路由器
✅ ctrol/config/config.php (5.9K) - 配置文件
✅ VERSION (28B) - 版本管理文件
✅ /admin/login.php → HTTP 200 + 带 footer
✅ /install/ → HTTP 403（安装锁激活）
✅ 所有核心路由规则生效
✅ 后台管理界面登录成功
✅ 后台 footer 可见
✅ 前端首页加载时间 < 300ms
✅ 后台图片管理自适应布局
```

**版本发布：v1.1.0 Stable**
- 发布URL：https://img.jzykk.com
- 状态：生产环境完全可用 ✅
- 功能覆盖：100% 完整
- 性能优化：90% 加载延迟降低

## 2026-02-10

- 目录结构调整：Gallery 为 public 根目录，ctrol/run 为非公开代码目录。
- 新增 CDN 渲染辅助函数，统一 Bootstrap/FontAwesome/Hammer 引入。
- 安装流程重整，修复死循环与配置写入逻辑。
- 安全加固：CSRF、登录限流、验证码、CSP 统一与 HTTPS 处理。

