### AI 开发任务指令：完善图片管理系统后台

系统是一个基于 PHP 的图片管理系统，包括文件上传、用户管理、图片列表等基础功能，但后台（admin backend）需要完善，如添加更多管理工具、安全性、用户权限、数据统计等。

---

**任务描述：继续开发 PHP 图片管理系统，重点完善管理后台**

你是一个资深的 PHP 开发者，擅长 Web 应用开发，包括 MySQL 数据库、文件上传、安全验证和后台管理。你将基于现有的半成品系统进行迭代开发。现有系统结构如下（基于提供的截图和文件列表）：

- **文件结构**：
  - 当前目录结构：Gallery (前台/公共入口/站点根目录)、ctrol (后台代码，非公开)、run (安装代码，非公开)。
  - 文档与备份目录：docs（开发/部署文档）、backup（备份目录，Gallery 同级）。
  - 核心文件：index.php (主页)、install.php (安装入口，转发到 run)、config.php (配置文件)、.htaccess (访问控制)、user.php (用户相关)、admin.php / admins.php (管理员相关)、add_image.php (添加图片)、delete_image.php (删除图片)、change_password.php (修改密码)、login.php / logout.php (登录/登出)、header.php / footer.php (页头/页脚)、modals.php (模态框)、upload.php (上传相关)、oss_config.json (对象存储配置)、404.php (错误页)。
  - 目录：uploads (图片上传目录)、assets (静态资源)。
  - 其他：JSON 配置如 oss_config.json。

- **当前功能（基于截图）**：
  - 仪表盘（Dashboard）：显示用户数（1）、图片数（11）、存储使用（0.00 GB）、访问统计图表（今日访问 0、总访问 0 等）。左侧菜单包括：站点配置、Logo/SEO、段落类型、会员管理、会员类型、公司类型设置、白名单管理、回收站、用户严禁词。
  - 图片列表页：显示图片卡片列表，包括 AI 生成图片、itubego 等，支持下载按钮。底部有分页或更多加载。
  - 单图片查看页：显示大图预览、描述文本（如“系统文件管理系统”）、下载/分享按钮。
  - 系统整体：中文界面，蓝色主题，支持图片上传和管理，看起来像一个简单的图床或图片托管系统。IP 显示如 123.45.67.89，版本 2026/02/01。

- **数据库假设**：假设使用 MySQL，表包括 users (用户)、images (图片)、admins (管理员)等。如果没有，需添加安装脚本。

**访问约定（必须遵守）**：
- 站点根目录为 Gallery。
- 安装入口通过 /install/ 访问（Gallery/install/ 为公开接口，实际逻辑在 run）。
- 后台入口通过 /admin/ 访问（Gallery/admin/ 为公开接口，实际逻辑在 ctrol）。

**开发目标**：
- 重点完善管理后台（admin backend），使其功能完整、用户友好、安全可靠。
- 保持现有 PHP 风格，无需框架（如 Laravel），但可以建议使用 Composer 添加必要库（如 PHPMailer for 邮件）。
- 确保代码安全：防止 SQL 注入、XSS、文件上传漏洞。
- 新功能应集成到现有文件中，或添加新文件（如 admin_users.php）。
- 输出：提供代码补全建议、SQL 脚本（如需要）、步骤说明。优先使用 PHP 7+ 或 8+。

**具体开发任务（分步执行）**：

0. **运维与紧急入口（必须保留说明）**：
  - reset_admin_password.php 仅用于管理员忘记密码的紧急场景。
  - 使用后应立即删除或限制访问，避免被扫描滥用。
  - 必须记录操作日志，避免“无痕修改管理员密码”的审计风险。

1. **安全与配置完善**：
   - 在 config.php 中添加数据库连接、密钥（用于 session/cookie）、上传路径配置。如果 oss.config 是阿里云 OSS 等，集成对象存储上传（可选）。
   - 添加 .htaccess 规则，禁止直接访问 uploads 目录，强制通过 PHP 下载图片。
   - 实现登录验证：在 login.php 中使用 password_hash / verify，添加 CAPTCHA 或 2FA（简单版）。
   - 处理 charge_password.php：完善密码修改功能，支持邮箱验证重置。

2. **用户管理模块（Admin > 用户管理）**：
   - 添加 admin_users.php：列出所有用户（表格形式：ID、用户名、邮箱、注册时间、最后登录、图片数）。
   - 支持操作：搜索、编辑用户（修改权限、密码）、删除/禁用用户、批量操作。
   - 添加用户角色：普通用户、管理员。使用 sessions 控制访问（e.g., if ($_SESSION['role'] != 'admin') die();）。
   - 集成到仪表盘：显示活跃用户统计。

3. **图片管理模块（Admin > 图片列表/审核）**：
   - 扩展 delete_image.php 和 add_image.php 为后台版本。
   - 添加 admin_images.php：图片表格列表（ID、上传者、文件名、大小、上传时间、预览缩略图）。
   - 支持：搜索（关键词、用户）、审核（批准/拒绝上传）、删除/批量删除、编辑元数据（标题、描述、标签）。
   - 添加水印功能：在上传时可选添加系统水印（使用 GD 或 Imagick 库）。
   - 统计：仪表盘显示热门图片、总下载次数。

4. **设置与SEO模块（Admin > 站点配置/SEO）**：
   - 添加 admin_settings.php：表单编辑站点标题、描述、关键词、Logo 上传。
  - 支持备份/恢复 config.php（备份文件放在 backup 目录，禁止 Web 直接访问）。
   - 添加白名单管理：IP/用户白名单，防止滥用。

5. **统计与日志模块（Admin > 访问统计/日志）**：
   - 扩展仪表盘图表：使用 Chart.js 或简单 PHP 生成更多图（e.g., 周/月访问、用户增长）。
   - 添加 admin_logs.php：记录登录、上传、删除等操作（存入数据库表 logs）。

6. **其他完善**：
   - 回收站功能：删除图片时移入回收站（新目录 recycled），支持恢复/永久删除。
   - 会员类型/段落类型：如果现有，添加 CRUD 接口（创建、读取、更新、删除）。
   - 优化上传：支持多文件上传、进度条（使用 AJAX）、大小/格式限制（e.g., JPG/PNG < 5MB）。
   - 错误处理：完善 404.php，添加全局错误日志。
   - 移动端适配：确保界面响应式（使用 Bootstrap 如果需要）。

**输出格式**：
- 对于每个任务，提供：
  - 说明：为什么添加这个功能。
  - 代码片段：PHP 代码、HTML/JS 如果需要。
  - SQL：如果涉及数据库更改。
- 最终提供完整更新后的文件列表建议。
- 测试步骤：如何验证新功能。

**约束**：
- 不要重写整个系统，只补全缺失部分。
- 假设数据库已设（如果未，添加 install.php 扩展创建表）。
- 如果需要外部库，说明如何安装（但优先用内置）。
- 保持中文界面一致。

**部署与路由说明（必须）**：
- 站点根目录为 Gallery。
- 安装入口为 /install/（Gallery/install/ 对外，实际逻辑在 run）。
- 后台入口为 /admin/（Gallery/admin/ 对外，实际逻辑在 ctrol）。
- 如访问 404，需配置 Web 服务器路由：
  - 宝塔/aapanel (Nginx)：站点根目录指向 Gallery，并为 /install/、/admin/ 添加 try_files 指向各自 index.php。
  - 1panel (Nginx)：同上，确保站点根目录为 Gallery。
  - Apache：开启 AllowOverride 并确保 DocumentRoot 指向 Gallery。
  - Docker (Nginx + PHP-FPM)：容器内 root 指向 Gallery，并配置 /install/、/admin/ 路由。
  - 自建环境：按 Nginx 或 Apache 规则配置。

**开发记录与部署说明**：
- 变更记录写入 docs/开发记录.md。
- 配置说明写入 docs/部署说明.md。


---

以下是**强烈禁止 / 必须避免**的事项清单。这些事项基于你系统的特点（PHP + 文件上传 + 管理后台 + 可能涉及用户上传图片）整理，按严重程度和出现频率排序。

## 重要 **禁止开发回复过程中采用非中文的方式思考和回复**

### 1. 文件上传相关（最致命，99% 的图片系统被黑都是这里出问题）

- **禁止**：只检查文件后缀名（.jpg/.png/.gif/.webp）就允许上传  
  攻击者可以用 `shell.php.jpg`、`shell.php;.jpg`、`shell.php%00.jpg` 等方式绕过。

- **禁止**：只靠前端 JS 或 MIME 类型（$_FILES['type']）判断文件类型  前端可以直接禁用 JS，后端 MIME 很容易伪造。
  推荐做法：使用 getimagesize()、finfo_file() 等服务器端方法验证图片真实性。


- **禁止**：把 uploads 目录放在 Web 可直接访问的根目录下，且没有做任何限制  
  → 攻击者一旦上传 webshell（如一句话木马），就能直接 /uploads/shell.php 执行命令。
    推荐做法：把 uploads 放在 Web 根目录之外，或至少放在子目录并用 .htaccess 禁止直接访问。

- **禁止**：允许上传 .php / .php5 / .phtml / .inc / .htaccess / .user.ini 等可执行后缀  
  即使你认为自己过滤了，也要从白名单角度彻底禁止。

- **禁止**：上传目录下允许解析 PHP（尤其是 Apache + mod_php 环境）  
  推荐做法：uploads 目录下放 .htaccess 禁止 PHP 执行，或 Nginx 配置 location ~* \.php$ { deny all; }

- **禁止**：不处理图片二次渲染/压缩就直接存原文件  
  攻击者可上传图片马（在合法 JPG 里藏 PHP 代码），浏览器打开没事，但被包含或解析时执行代码。

- **禁止**：文件名不重命名，直接用用户上传的原文件名保存  
  容易导致目录遍历、文件名注入、覆盖系统文件等。

### 2. 后台权限与认证相关

- **禁止**：后台页面（如 admin.php）不做登录状态检查，或只检查 cookie 存在  
  → 攻击者猜到后台路径就能直接进。

- **禁止**：session 固定、没有超时、没有 regenerate id  
  → session 劫持风险极高。

- **禁止**：密码明文存储或使用 md5 而不加盐  
  现在至少要用 password_hash()。

- **禁止**：后台任何操作不验证 CSRF token  
  管理员一点击恶意链接，就可能被批量删除图片、改密码、添加管理员。

- **禁止**：使用默认/弱后台路径（如 /admin、/manage、/gadmin）且没有改动  
  扫描器一扫就出来。

- **禁止**：没有角色权限分级（超级管理员 vs 普通管理员 vs 上传员）  
  导致低权限用户能访问高危功能。

### 3. 输入输出处理相关

- **禁止**：任何地方直接 echo/print_r/var_dump 用户输入（包括文件名、描述）  
  → 存储型/反射型 XSS 直接打管理员。

- **禁止**：SQL 语句直接拼接用户输入（用户名、搜索关键词等）  
  → SQL 注入，拖库、改管理员密码一秒搞定。

- **禁止**：不限制上传文件大小（或只前端限制）  
  → 容易被用来做拒绝服务（上传 2GB 文件把磁盘占满）。

- **禁止**：错误信息直接输出到页面（如 “mysql error: …”）  
  → 泄露数据库结构、路径、版本。

### 4. 系统配置与环境相关

- **禁止**：线上环境开启 display_errors = On  
  → 路径、变量全部暴露。

- **禁止**：install 目录、config.php.bak、.user 等敏感文件仍放在 Web 可访问目录下  
  → 攻击者直接下载你的数据库密码、密钥。建议统一放入 backup 目录并加访问控制。

- **禁止**：使用 eval()、assert()、system()、exec()、passthru() 等危险函数处理用户输入  
  哪怕是“调试模式”也别留。

- **禁止**：把 uploads 目录和系统核心代码目录混在一起  
  上传漏洞直接波及整个站点。

### 5. 其他高危行为

- **禁止**：后台批量操作（删除/审核）不加二次确认或验证码  
  → CSRF + 批量删图一键清空。

- **禁止**：日志不记录管理员关键操作（登录、改密、删图、加用户）  
  → 事后无法追溯谁干的。

- **禁止**：长期使用默认/弱密钥（JWT、加密 cookie、oss key 等）  
  你的 oss_config 看起来是对象存储密钥，泄露等于全站图片被删/改。

- **禁止**：不限制后台登录尝试次数  
  → 暴力破解管理员密码。

### 建议的“红线级”检查清单（开发前/后必过）

1. 所有上传 → 白名单 + MIME 检查 + getimagesize() 二次验证 + 图片重采样保存
2. 所有后台页面 → session + role 检查 + CSRF token
3. 所有 SQL → 预处理语句 / PDO 参数绑定
4. 所有输出 → htmlspecialchars() / filter_var()
5. 所有敏感文件 → 移出 Web 根目录 或 .htaccess 禁止访问
6. 上传目录 → 禁止 PHP 执行 + 随机文件名 + 按日期/用户分目录

把这些禁止事项列成 checklist 贴在开发文档或代码注释里，每次让 AI 生成/修改代码前都先提醒它遵守这些红线，能大幅降低被黑的风险。

---

### 备份与存储策略（实施建议）

- 备份目录统一放在 backup，禁止 Web 直接访问。
- 备份接口建议支持：OSS、OneDrive、S3、COS、Ceph、OpenStack Swift。
- 非必要不从云端下载备份文件到线上机器，优先在受控环境恢复。

