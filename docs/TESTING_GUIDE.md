# 🧪 快速测试指南 - 图片上传和压缩功能

## 📱 环境检查

```bash
# 访问该 URL 检查 PHP GD 库和图片处理能力
http://img.jzykk.com/test_image_compress.php
```

预期输出：所有 GD 库函数都被标记为 ✅

---

## 🎯 测试场景

### 场景 1：添加图片 - 前端验证

**URL**: http://img.jzykk.com/admin 或首页的"添加图片"按钮

**测试步骤**:
1. 点击"添加图片"按钮打开模态框
2. 选择类型：本地上传
3. 尝试选择大小超过 6MB 的图片
4. **预期结果**：显示错误 "文件太大 (X.X MB), 最大允许6MB" ❌

**修复步骤**:
1. 选择大小在 1-6MB 之间的图片
2. 填写标题和描述
3. 点击"添加"按钮
4. **预期结果**：成功提示，图片列表更新 ✅

---

### 场景 2：编辑图片 - 更新图片文件

**URL**: http://img.jzykk.com/admin 的图片编辑按钮

**测试步骤**:
1. 在图片上点击编辑按钮
2. 在"更新图片"字段选择一个 3-5MB 的新图片
3. 点击"保存"按钮
4. **预期结果**：
   - 成功提示："编辑成功"
   - 图片列表中的图片已更新
   - 数据库中的文件大小 ≤ 800KB

---

### 场景 3：压缩验证

**检查压缩效果**:

```php
// 可以在 admin.php 中添加临时调试代码
<?php
$stmt = $pdo->prepare("SELECT file_path FROM images LIMIT 1");
$stmt->execute();
$image = $stmt->fetch();
if ($image) {
    $filePath = upload_storage_path($image['file_path']);
    echo "File: " . basename($filePath);
    echo " | Size: " . round(filesize($filePath) / 1024, 2) . " KB";
}
?>
```

**预期结果**:
- 图片文件大小 ≤ 800KB
- 图片质量清晰可见（75% 质量）

---

### 场景 4：格式兼容性

**测试上传不同格式**:

| 格式 | 测试文件 | 预期结果 |
|------|---------|---------|
| JPG/JPEG | 任何 JPEG 图片 | ✅ 接受，保存为 JPEG |
| PNG | 任何 PNG 图片 | ✅ 接受，保存为 JPEG |
| GIF | 任何 GIF 图片 | ✅ 接受，保存为 JPEG |
| WebP | 任何 WebP 图片 | ✅ 接受，保存为 JPEG |
| BMP | 任何 BMP 图片 | ❌ 拒绝 |
| TIFF | 任何 TIFF 图片 | ❌ 拒绝 |

---

### 场景 5：边界测试

#### 5.1 超大文件 (> 6MB)

**上传**: 一个 10MB 的 JPEG 图片

**预期**:
```
❌ 文件太大 (10.0 MB), 最大允许6MB
```

#### 5.2 恰好 6MB

**上传**: 大小为 6MB 的精确图片

**预期**:
```
✅ 上传成功，压缩后 < 800KB
```

#### 5.3 小图片 (< 100KB)

**上传**: 一个很小的图片 (50KB)

**预期**:
```
✅ 上传成功，保存大小接近原始大小
```

---

## 📊 性能验证

### 压缩效率检查

使用浏览器开发工具检查网络请求：

1. **打开开发工具** (F12)
2. **进入 Network 标签**
3. **上传一个 3MB 的图片**
4. **查看 XHR 请求**

**预期**:
- 上传请求：~3MB（原始文件）
- 响应时间：1-3 秒（取决于服务器和压缩复杂度）
- 成功状态：200 OK

### 数据库验证

```sql
-- 连接数据库查询图片文件大小
SELECT id, title, file_path, created_at FROM images LIMIT 10;

-- 检查实际文件大小
-- 可以通过文件管理器查看 uploads/ 目录中的文件大小
```

**预期**:
- 所有 JPG 文件 ≤ 800KB
- 文件名为 16 位十六进制 + .jpg (如: abc123def456.jpg)

---

## 🔍 常见问题排查

### 问题 1：GD 库未启用

**症状**：图片上传失败，显示 "图片压缩失败"

**解决**:
1. 检查 PHP 扩展：`php -m | grep gd`
2. 编辑 php.ini：取消注释 `extension=gd`
3. 重启 PHP FPM 或 Apache
4. 验证：访问 `test_image_compress.php`

### 问题 2：内存不足

**症状**：上传大图片时出错

**解决**:
1. 增加 PHP.ini 中的 memory_limit
   ```ini
   memory_limit = 512M  ; 或更高
   ```
2. 重启 Web 服务器

### 问题 3：文件权限问题

**症状**：图片上传失败，显示 "文件上传失败"

**解决**:
1. 检查 uploads/ 目录权限：`ls -la uploads/`
2. 确保权限为 755 或 775
3. 修复：`chmod 755 uploads/`

### 问题 4：超时问题

**症状**：上传大文件时请求超时

**解决**:
1. 增加 PHP 超时时间：
   ```ini
   max_execution_time = 300  ; 1-5 分钟
   ```
2. 增加 Web 服务器超时：
   - Nginx: `proxy_read_timeout 300s;`
   - Apache: `TimeOut 300`

---

## ✅ 最终检查清单

- [ ] 访问 `test_image_compress.php` 验证 GD 库
- [ ] 成功上传 1-2MB 图片
- [ ] 成功上传 5-6MB 图片
- [ ] 上传超过 6MB 的图片被拒绝
- [ ] 编辑图片时可以更新图片文件
- [ ] 所有图片文件 ≤ 800KB
- [ ] 图片质量清晰可见
- [ ] 错误提示正确显示（中文）
- [ ] Web 日志中无 PHP 错误

---

## 🎉 完成标志

当以下全部情况都满足时，功能已完全就绪：

1. ✅ 前端表单验证工作（6MB 限制）
2. ✅ 后端接收并压缩图片（目标 800KB）
3. ✅ 数据库中保存了文件路径
4. ✅ 用户可以看到原始图片（未失真）
5. ✅ 带宽消耗降低（60-80%）
6. ✅ 所有错误提示清晰友好

---

## 📞 调试信息

如需进行技术调试，可以在 PHP 文件中临时添加：

```php
// 调试：记录压缩过程
error_log("开始压缩：" . $sourcePath);
error_log("原始大小：" . filesize($sourcePath));
// ... 压缩代码 ...
error_log("压缩后大小：" . filesize($targetPath));
```

然后查看 PHP 错误日志：
```bash
tail -f /var/log/php-fpm/error.log
```

---

**祝测试顺利！** 🚀
